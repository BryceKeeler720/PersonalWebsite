---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import BlogNavbar from '../components/blog/BlogNavbar.astro';
import { getWordCount } from '../utils/readingTime';
import JournalHeatmap from '../components/journal/JournalHeatmap';
import JournalKnowledgeMap from '../components/journal/JournalKnowledgeMap';

type JournalEntry = CollectionEntry<'journal'>;

const entries: JournalEntry[] = (await getCollection('journal', ({ data }: JournalEntry) => !data.draft))
  .sort((a: JournalEntry, b: JournalEntry) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// Serialize entries for React components
const entryData = entries.map((entry: JournalEntry) => ({
  slug: entry.slug,
  title: entry.data.title,
  publishDate: entry.data.publishDate.toISOString().split('T')[0],
  tags: entry.data.tags,
  wordCount: getWordCount(entry.body),
}));
---

<BaseLayout title="Journal | Bryce Keeler" description="Quick notes, updates, and things I'm working on.">
  <BlogNavbar />

  <main class="journal-page">
    <header class="journal-header">
      <h1>Journal</h1>
      <p class="journal-subtitle">Quick notes and updates</p>
    </header>

    <!-- Heatmap with stats and year navigation -->
    <section class="journal-section">
      <JournalHeatmap entries={entryData} client:load />
    </section>

    <!-- Knowledge Map -->
    <section class="journal-section">
      <h2 class="section-title">Knowledge Map</h2>
      <JournalKnowledgeMap entries={entryData} client:load />
    </section>

    <!-- Entry List -->
    <section class="journal-section">
      <h2 class="section-title">All Entries</h2>
      <div class="journal-entries">
        {entries.length === 0 ? (
          <p class="journal-empty">Nothing here yet.</p>
        ) : (
          entries.map((entry: JournalEntry) => {
            const wordCount = getWordCount(entry.body);
            const formattedDate = entry.data.publishDate.toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
            });

            return (
              <a href={`/journal/${entry.slug}`} class="journal-entry">
                <span class="entry-title">{entry.data.title}</span>
                <span class="entry-right">
                  {entry.data.tags.length > 0 && (
                    <span class="entry-tags">
                      {entry.data.tags.map((tag: string) => (
                        <span class="entry-tag">{tag}</span>
                      ))}
                    </span>
                  )}
                  <span class="entry-words">{wordCount} words</span>
                  <span class="entry-date">{formattedDate}</span>
                </span>
              </a>
            );
          })
        )}
      </div>
    </section>
  </main>

  <footer class="journal-footer">
    <div class="footer-content">
      <p>Bryce Keeler · 2026</p>
      <div class="footer-links">
        <a href="/">Home</a>
        <span>·</span>
        <a href="/blog">Blog</a>
        <span>·</span>
        <a href="/traditional">Portfolio</a>
      </div>
    </div>
  </footer>
</BaseLayout>

<style>
  .journal-page {
    min-height: 100vh;
    padding: 8rem 2rem 4rem;
    max-width: 720px;
    margin: 0 auto;
  }

  .journal-header {
    margin-bottom: 2.5rem;
  }

  .journal-header h1 {
    font-size: clamp(2rem, 5vw, 2.75rem);
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .journal-subtitle {
    color: var(--text-secondary);
    font-size: 1rem;
  }

  .journal-section {
    margin-bottom: 3rem;
  }

  .section-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1rem;
  }

  .journal-entries {
    display: flex;
    flex-direction: column;
  }

  .journal-empty {
    color: var(--text-secondary);
    text-align: center;
    padding: 3rem 0;
  }

  .journal-entry {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1.5rem;
    padding: 0.875rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    text-decoration: none;
    transition: background 0.2s ease;
  }

  .journal-entry:first-child {
    border-top: 1px solid rgba(255, 255, 255, 0.06);
  }

  .journal-entry:hover {
    background: rgba(255, 255, 255, 0.02);
  }

  .entry-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .entry-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-shrink: 0;
  }

  .entry-date {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }

  .entry-tags {
    display: flex;
    gap: 0.375rem;
  }

  .entry-tag {
    font-size: 0.6875rem;
    padding: 0.125rem 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    color: var(--text-secondary);
  }

  .entry-words {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.4);
    white-space: nowrap;
  }

  .journal-footer {
    padding: 3rem 2rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(0, 0, 0, 0.5);
  }

  .footer-content {
    max-width: 720px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    text-align: center;
  }

  .footer-content p {
    color: var(--text-secondary);
    font-size: 0.9375rem;
  }

  .footer-links {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .footer-links a {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.3s ease;
  }

  .footer-links a:hover {
    color: var(--primary-color);
  }

  .footer-links span {
    color: rgba(255, 255, 255, 0.2);
  }

  @media (max-width: 768px) {
    .journal-page {
      padding: 6rem 1.5rem 3rem;
    }

    .journal-entry {
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.875rem 0;
    }

    .entry-right {
      flex-wrap: wrap;
    }

    .footer-links {
      flex-direction: column;
      gap: 0.5rem;
    }

    .footer-links span {
      display: none;
    }
  }
</style>
