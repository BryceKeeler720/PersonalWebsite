name: Send Newsletter

on:
  push:
    branches:
      - main
    paths:
      - 'src/content/blog/*.md'
      - 'src/content/blog/*.mdx'

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get new blog posts and send to Buttondown
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
        run: |
          if [ -z "$BUTTONDOWN_API_KEY" ]; then
            echo "ERROR: BUTTONDOWN_API_KEY secret is not set!"
            exit 1
          fi

          git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'src/content/blog/*.md' 'src/content/blog/*.mdx' > /tmp/new_files.txt 2>/dev/null || true

          if [ ! -s /tmp/new_files.txt ]; then
            echo "No new blog posts found in this commit"
            exit 0
          fi

          echo "Found new blog posts:"
          cat /tmp/new_files.txt

          while IFS= read -r file; do
            echo "Processing: $file"

            if [ ! -f "$file" ]; then
              echo "File not found, skipping"
              continue
            fi

            TITLE=$(sed -n '/^---$/,/^---$/p' "$file" | grep -E '^title:' | head -1 | sed "s/^title:[[:space:]]*//; s/^[\"']//; s/[\"']$//")

            if [ -z "$TITLE" ]; then
              echo "Could not extract title, skipping"
              continue
            fi

            SLUG=$(basename "$file" | sed 's/\.mdx\?$//')
            BODY=$(awk '/^---$/{n++; next} n>=2{print}' "$file")
            LINK="[Read the full post on my website](https://brycekeeler.com/blog/$SLUG)"
            FULL_BODY=$(printf "%s\n\n---\n\n%s" "$BODY" "$LINK")

            echo "Title: $TITLE"
            echo "Slug: $SLUG"
            echo "Sending to Buttondown..."

            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.buttondown.email/v1/emails" \
              -H "Authorization: Token $BUTTONDOWN_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg subject "$TITLE" --arg body "$FULL_BODY" '{subject: $subject, body: $body, status: "draft"}')")

            HTTP_CODE=$(echo "$RESPONSE" | tail -1)

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "Draft created successfully for: $TITLE"
            else
              echo "ERROR: Failed to create draft (HTTP $HTTP_CODE)"
              echo "$RESPONSE" | sed '$d'
            fi

          done < /tmp/new_files.txt

          echo "Newsletter processing complete!"
