name: Send Newsletter

on:
  push:
    branches:
      - main
    paths:
      - 'src/content/blog/*.md'
      - 'src/content/blog/*.mdx'

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get new blog posts
        id: get-posts
        run: |
          # Get list of added markdown files in this commit
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'src/content/blog/*.md' 'src/content/blog/*.mdx' 2>/dev/null || echo "")

          if [ -z "$NEW_FILES" ]; then
            echo "No new blog posts found"
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found new blog posts:"
          echo "$NEW_FILES"
          echo "has_new_posts=true" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Buttondown
        if: steps.get-posts.outputs.has_new_posts == 'true'
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
        run: |
          for file in ${{ steps.get-posts.outputs.files }}; do
            echo "Processing: $file"

            # Extract frontmatter and content
            CONTENT=$(cat "$file")

            # Extract title from frontmatter
            TITLE=$(echo "$CONTENT" | sed -n '/^---$/,/^---$/p' | grep '^title:' | sed 's/title: *["'\'']*\([^"'\'']*\)["'\'']*$/\1/')

            # Extract description from frontmatter
            DESCRIPTION=$(echo "$CONTENT" | sed -n '/^---$/,/^---$/p' | grep '^description:' | sed 's/description: *["'\'']*\([^"'\'']*\)["'\'']*$/\1/')

            # Get the slug from filename
            SLUG=$(basename "$file" .md | sed 's/.mdx$//')

            # Extract body (everything after second ---)
            BODY=$(echo "$CONTENT" | sed '1,/^---$/d' | sed '1,/^---$/d')

            # Add link to full post
            FULL_BODY="$BODY

---

[Read the full post on my website](https://brycekeeler.com/blog/$SLUG)"

            echo "Title: $TITLE"
            echo "Sending to Buttondown..."

            # Create draft email via Buttondown API
            curl -X POST "https://api.buttondown.com/v1/emails" \
              -H "Authorization: Token $BUTTONDOWN_API_KEY" \
              -H "Content-Type: application/json" \
              -d @- <<PAYLOAD
            {
              "subject": "$TITLE",
              "body": $(echo "$FULL_BODY" | jq -Rs .),
              "status": "draft"
            }
          PAYLOAD

            echo ""
            echo "Draft created for: $TITLE"
          done
